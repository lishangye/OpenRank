<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的关注 · OpenRank</title>
    <style>
        body { margin:0; font-family: system-ui,-apple-system,sans-serif; background:#050910; color:#e2e8f0; }
        .page { max-width:1100px; margin:0 auto; padding:28px 16px 40px; }
        .top { display:flex; justify-content:space-between; align-items:center; gap:12px; }
        .card { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); padding:16px; border-radius:14px; margin-top:12px; }
        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .tag { padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); color:#94a3b8; font-size:12px; }
        .heart-btn { width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.02); color:#f97316; cursor:pointer; }
        .empty { color:#94a3b8; margin-top:20px; }
        a { color:#4fd1c5; text-decoration:none; }
        .title-link { color:#e2e8f0; text-decoration:none; }
        .title-link:hover { text-decoration:underline; color:#4fd1c5; }
    </style>
</head>
<body>
<div class="page">
    <div class="top">
        <div>
            <h1>我的关注</h1>
            <p id="hint" style="color:#94a3b8;">加载中...</p>
        </div>
        <div class="row">
            <a href="/">返回首页</a>
            <a id="login-link" href="/login.html">登录</a>
        </div>
    </div>
    <div id="list"></div>
</div>
<script>
    const listEl = document.getElementById('list');
    const hint = document.getElementById('hint');
    const loginLink = document.getElementById('login-link');
    const token = localStorage.getItem('openrank_token') || '';
    if (!token) {
        hint.textContent = '请先登录再查看关注列表';
    } else if (loginLink) {
        loginLink.style.display = 'none';
    }

    let favorites = [];
    let projects = [];

    async function fetchProjects() {
        projects = [];
        // 先尝试从数据库榜单获取更多仓库（与 discovery 页面一致）
        try {
            const resp = await fetch('/api/projects/discovery?limit=200&periodType=MONTH');
            if (resp.ok) {
                projects = await resp.json();
            }
        } catch (e) { /* ignore */ }
        // 补充周榜，防止月榜没有覆盖
        try {
            const resp = await fetch('/api/projects/discovery?limit=200&periodType=WEEK');
            if (resp.ok) {
                const weekList = await resp.json();
                const map = new Map(projects.map(p => [p.repo, p]));
                weekList.forEach(p => map.set(p.repo, p));
                projects = Array.from(map.values());
            }
        } catch (e) { /* ignore */ }
        // 回退补充 OpenDigger 预置列表，保证收藏仓库能匹配到详情字段
        try {
            const resp = await fetch('/api/projects');
            if (resp.ok) {
                const list = await resp.json();
                const map = new Map(projects.map(p => [p.repo, p]));
                list.forEach(p => map.set(p.repo, p));
                projects = Array.from(map.values());
            }
        } catch (e) { /* ignore */ }
    }

    async function fetchFavorites() {
        if (!token) return;
        const resp = await fetch('/api/favorites', { headers: { 'X-Token': token } });
        if (resp.ok) {
            favorites = await resp.json();
        }
    }

    function render() {
        if (!token) return;
        if (!favorites.length) {
            listEl.innerHTML = '<div class="empty">还没有关注任何仓库</div>';
            hint.textContent = '已登录';
            return;
        }
        const map = new Map(projects.map(p => [p.repo, p]));
        listEl.innerHTML = favorites.map(fav => {
            const p = map.get(fav.repo);
            const display = p || { repo: fav.repo, name: fav.repo, status: '', description: '来自收藏，暂未同步到榜单', tags: [] };
            return `
            <div class="card">
                <div class="row">
                    <strong><a class="title-link" href="/repo.html?repo=${encodeURIComponent(display.repo)}">${display.name || display.repo}</a></strong>
                    <span class="tag">${display.repo}</span>
                    <span class="tag">${display.status || ''}</span>
                    <button class="heart-btn" data-repo="${display.repo}">❤</button>
                </div>
                <div style="margin-top:6px; color:#cbd5e1;">${display.description || '暂无描述'}</div>
            </div>`;
        }).join('');
        hint.textContent = `已登录 · 关注 ${favorites.length} 个仓库`;
    }

    async function removeFavorite(repo) {
        if (!token) return;
        const resp = await fetch('/api/favorites', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json', 'X-Token': token },
            body: JSON.stringify({ repo })
        });
        if (resp.ok) {
            favorites = favorites.filter(f => f.repo !== repo);
            render();
        }
    }

    listEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-repo]');
        if (btn) {
            const repo = btn.getAttribute('data-repo');
            removeFavorite(repo);
        }
    });

    (async function init() {
        if (!token) return;
        await Promise.all([fetchProjects(), fetchFavorites()]);
        render();
    })();
</script>
</body>
</html>

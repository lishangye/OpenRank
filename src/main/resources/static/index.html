<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenRank · AI 项目管理启动盘</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050910;
            --panel: #0c1322;
            --panel-alt: #0f1a2c;
            --accent: #4fd1c5;
            --accent-strong: #f97316;
            --muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --gradient: radial-gradient(circle at 10% 20%, rgba(79, 209, 197, 0.12), transparent 35%), radial-gradient(circle at 90% 10%, rgba(249, 115, 22, 0.10), transparent 30%), linear-gradient(135deg, #0a1220 0%, #050910 45%, #070b14 100%);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Space Grotesk', 'Manrope', system-ui, -apple-system, sans-serif;
            background: var(--gradient);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 20px 48px;
        }

        .glass {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01));
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
            border-radius: 18px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 18px;
            margin-bottom: 18px;
            gap: 14px;
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .logo {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(79, 209, 197, 0.2), rgba(79, 209, 197, 0.05));
            border: 1px solid var(--border);
            display: grid;
            place-items: center;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--accent);
        }

        .brand-name { font-weight: 700; font-size: 18px; }
        .brand-sub { color: var(--muted); font-size: 13px; }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 999px;
            background: rgba(79, 209, 197, 0.12);
            color: var(--accent);
            border: 1px solid var(--border);
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .search {
            position: relative;
        }

        .search input {
            background: var(--panel);
            border: 1px solid var(--border);
            color: #e2e8f0;
            padding: 10px 12px;
            border-radius: 10px;
            width: 240px;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .token-badge {
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(79, 209, 197, 0.35);
            background: rgba(79, 209, 197, 0.12);
            color: var(--accent);
            font-weight: 700;
            max-width: 100%;
            word-break: break-all;
        }
        .link-btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            color: #e2e8f0;
            text-decoration: none;
            background: rgba(255,255,255,0.02);
        }
        .title-link {
            color: #e2e8f0;
            text-decoration: none;
        }
        .title-link:hover {
            text-decoration: underline;
            color: var(--accent);
        }
        .heart-btn {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.02);
            color: #94a3b8;
            font-size: 16px;
            cursor: pointer;
        }
        .heart-btn.active {
            border-color: rgba(79, 209, 197, 0.35);
            color: #f97316;
            background: rgba(79, 209, 197, 0.08);
        }
        .clickable { cursor: pointer; }

        .search input:focus {
            outline: none;
            border: 1px solid rgba(79, 209, 197, 0.5);
            box-shadow: 0 0 0 6px rgba(79, 209, 197, 0.1);
        }

        .hero {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 20px;
            padding: 24px;
            margin-bottom: 18px;
        }

        .eyebrow {
            color: var(--accent);
            font-weight: 600;
            margin: 0 0 6px;
            letter-spacing: 0.3px;
        }

        h1 {
            margin: 0 0 12px;
            font-size: 32px;
            line-height: 1.2;
        }

        .lede {
            margin: 0 0 18px;
            color: var(--muted);
            line-height: 1.6;
        }

        .hero-actions { display: flex; gap: 12px; flex-wrap: wrap; }

        button {
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            letter-spacing: 0.2px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .primary {
            background: linear-gradient(135deg, #4fd1c5, #22c55e);
            color: #04100b;
            padding: 12px 16px;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
        }

        .ghost {
            background: transparent;
            color: #e2e8f0;
            border: 1px solid var(--border);
            padding: 12px 16px;
        }

        button:hover { transform: translateY(-1px); }
        button:active { transform: translateY(0); }

        .callout {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 18px;
            border-radius: 14px;
            height: 100%;
        }

        .callout-title {
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .callout-title::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 0 10px rgba(79, 209, 197, 0.12);
        }

        .callout ul {
            list-style: none;
            padding-left: 0;
            margin: 10px 0 0;
            color: var(--muted);
            line-height: 1.6;
        }

        .callout li {
            margin-bottom: 6px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-bottom: 18px;
        }

        .stat-card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: 14px;
        }

        .stat-label { color: var(--muted); margin-bottom: 6px; }
        .stat-value { font-size: 26px; font-weight: 700; margin-bottom: 6px; }

        .trend {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            color: #0f172a;
            background: rgba(79, 209, 197, 0.85);
        }

        .board {
            background: var(--panel-alt);
            border: 1px solid var(--border);
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 18px;
        }

        .board-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .board-header h2 {
            margin: 0;
            font-size: 22px;
        }

        .board-sub { color: var(--muted); margin: 4px 0 0; }

        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter {
            padding: 8px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            color: #e2e8f0;
            border: 1px solid var(--border);
            font-weight: 600;
        }

        .filter.active {
            background: rgba(79, 209, 197, 0.15);
            color: var(--accent);
            border-color: rgba(79, 209, 197, 0.35);
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 12px;
        }

        .card {
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
            border: 1px solid var(--border);
            padding: 14px;
            border-radius: 14px;
            display: grid;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 80% 10%, rgba(79, 209, 197, 0.08), transparent 40%);
            pointer-events: none;
        }

        .card header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .status-pill {
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid var(--border);
        }

        .status-production { color: #0f172a; background: rgba(79, 209, 197, 0.9); }
        .status-beta { color: #111827; background: rgba(249, 115, 22, 0.9); }
        .status-lab { color: #e2e8f0; background: rgba(226, 232, 240, 0.1); }

        .title { font-weight: 700; font-size: 17px; margin-bottom: 4px; }
        .meta { color: var(--muted); font-size: 13px; }
        .desc { color: #cbd5e1; line-height: 1.5; }

        .tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 6px 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--muted);
            font-size: 12px;
            border: 1px solid var(--border);
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .metric {
            display: grid;
            gap: 2px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            padding: 8px 10px;
            border-radius: 10px;
        }

        .metric .label { color: var(--muted); font-size: 12px; }
        .metric .value { font-weight: 700; }

        .tasks {
            background: rgba(79, 209, 197, 0.05);
            border: 1px dashed rgba(79, 209, 197, 0.3);
            padding: 10px;
            border-radius: 12px;
            color: #cbd5e1;
            font-size: 13px;
            line-height: 1.5;
        }

        .ai-dock {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 14px;
        }

        .playbook, .embed-box {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: 14px;
        }

        .playbook h3, .embed-box h3 { margin: 0 0 10px; }
        .playbook ol { margin: 6px 0 0 18px; color: var(--muted); line-height: 1.6; }
        .playbook li { margin-bottom: 6px; }

        .embed-box .note {
            color: var(--muted);
            font-size: 13px;
            line-height: 1.5;
        }

        .embed-target {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 12px;
        }

        .note-line {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            font-size: 13px;
        }

        .note-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 0 8px rgba(79, 209, 197, 0.12);
        }

        @keyframes floatIn {
            from { transform: translateY(8px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .card, .stat-card, .playbook, .embed-box, .callout {
            animation: floatIn 0.35s ease forwards;
        }

        @media (max-width: 960px) {
            .hero { grid-template-columns: 1fr; }
            .ai-dock { grid-template-columns: 1fr; }
            .board-header { align-items: flex-start; }
            .topbar { flex-direction: column; align-items: flex-start; }
            .top-actions { width: 100%; justify-content: flex-start; }
            .search input { width: 100%; }
        }
    </style>
</head>
<body>
<div class="page glass">
    <header class="topbar">
        <div class="brand">
            <div class="logo">OR</div>
            <div>
                <div class="brand-name">OpenRank Launchpad</div>
                <div class="brand-sub">开箱即用的 AI 助力项目管理</div>
            </div>
        </div>
        <div class="top-actions">
            <div class="pill">伪造数据 · 演示用</div>
            <div class="search">
                <input id="search" type="text" placeholder="搜索项目 / 维护者 / 标签">
            </div>
        </div>
        <div id="auth-bar" class="top-actions" style="flex-wrap: wrap; justify-content: flex-end; width: 100%; margin-top: 8px;">
            <div class="pill" id="auth-hint">未登录</div>
            <a class="link-btn" id="login-link" href="/login.html">登录</a>
            <a class="link-btn" id="register-link" href="/register.html">注册</a>
            <button id="logout-btn" class="ghost" style="display:none;">退出</button>
        </div>
    </header>

    <section class="hero">
        <div>
            <p class="eyebrow">AI 驱动的开源运营</p>
            <h1>一屏看清最新开源项目，自动分拣优先级</h1>
            <p class="lede">结合 Star 增长、提交活跃度与交付状态，AI 帮你挑出值得跟进的仓库。页面暂用伪造数据演示，真实环境可挂接内部指标。</p>
            <div class="hero-actions">
                <button class="primary">推送到工作流</button>
                <button class="ghost">导出清单</button>
            </div>
        </div>
        <div class="callout">
            <div class="callout-title">AI 诊断速览</div>
            <ul>
                <li>高势能：OpenGraph Atlas、Cortex Gateway，本周 Star 同比 +18%</li>
                <li>需介入：DataShaper Pipeline，Issue 处理时长 > 72h</li>
                <li>冷静观察：EdgeSim Agent，近 7 天活跃度下降但仍有新访客</li>
            </ul>
        </div>
    </section>

    <section class="stats">
        <div class="stat-card clickable" id="follow-card">
            <div class="stat-label">跟进项目</div>
            <div class="stat-value" id="follow-count">0</div>
            <div class="trend" id="follow-trend">登录后统计</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">AI 自动生成的待办</div>
            <div class="stat-value">42</div>
            <div class="trend">+9 本周</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">优先跟进</div>
            <div class="stat-value">6</div>
            <div class="trend" style="background: rgba(249, 115, 22, 0.85);">高优</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">平均响应时长</div>
            <div class="stat-value">5.4 h</div>
            <div class="trend">自动派单中</div>
        </div>
    </section>

    <section class="board">
        <div class="board-header">
            <div>
                <h2>最新开源项目清单</h2>
                <p class="board-sub">使用 OpenDigger 月度指标 · 结合 AI 评估优先级</p>
            </div>
            <div class="filters">
                <button class="filter active" data-filter="all">全部</button>
                <button class="filter" data-filter="agent">Agent</button>
                <button class="filter" data-filter="mlops">MLOps</button>
                <button class="filter" data-filter="data">Data</button>
                <button class="filter" data-filter="infra">Infra</button>
            </div>
        </div>
        <div id="status-line" class="board-sub"></div>
        <div id="project-grid" class="project-grid"></div>
    </section>

    <section class="board">
        <div class="board-header">
            <div>
                <h2>全部仓库</h2>
                <p class="board-sub">榜单 + 预置仓库合并视图（支持跳转详情）</p>
            </div>
        </div>
        <div id="all-status" class="board-sub"></div>
        <div id="all-grid" class="project-grid"></div>
    </section>

    <section class="ai-dock">
        <div class="playbook">
            <h3>AI 执行剧本（演示）</h3>
            <ol>
                <li>每日 09:00 抓取最新 Star / Fork / Issue 指标，更新项目热度。</li>
                <li>按影响力、趋势、维护者可用度排序，生成优先级清单。</li>
                <li>自动撰写 Issue 模板与 changelog 草稿，并推送到工作流。</li>
                <li>通过嵌入式对话，随时追加指令或确认下一步动作。</li>
            </ol>
        </div>
        <div class="embed-box">
            <h3>嵌入的对话助理</h3>
            <p class="note">在此直接发问（例如：“把高优仓库推送到看板”），由下方脚本注入的 AI 组件响应。</p>
            <div class="embed-target">
                <div class="note-line"><span class="note-dot"></span>Chat 组件已嵌入</div>
                <script
                        async
                        defer
                        src="http://localhost:8080/chat/api/embed?protocol=http&host=localhost:8080&token=99af731d48342b82">
                </script>
            </div>
        </div>
    </section>
</div>

<script>
    const grid = document.getElementById('project-grid');
    const allGrid = document.getElementById('all-grid');
    const searchInput = document.getElementById('search');
    const filterButtons = Array.from(document.querySelectorAll('.filter'));
    const statusLine = document.getElementById('status-line');
    const allStatusLine = document.getElementById('all-status');
    const authHint = document.getElementById('auth-hint');
    const tokenBox = document.getElementById('token-box');
    const logoutBtn = document.getElementById('logout-btn');
    let projects = [];
    let allProjects = [];
    let activeFilter = 'all';
    let authToken = localStorage.getItem('openrank_token') || '';
    let currentUser = localStorage.getItem('openrank_user') || '';
    let favorites = new Set();
    const followCountEl = document.getElementById('follow-count');
    const followTrendEl = document.getElementById('follow-trend');
    const followCard = document.getElementById('follow-card');

    function render(list) {
        if (!list.length) {
            grid.innerHTML = `
                <article class="card">
                    <div class="title">暂无匹配项目</div>
                    <div class="desc">试试换个关键词或切换标签。</div>
                </article>
            `;
            return;
        }

        grid.innerHTML = list.map(project => {
            const statusClass = project.status === 'production' ? 'status-production' : project.status === 'beta' ? 'status-beta' : 'status-lab';
            const tasks = (project.tasks || []).map(item => `<div>· ${item}</div>`).join('');
            const tags = (project.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('');
            const isFav = favorites.has(project.repo);
            return `
            <article class="card">
                <header>
                    <div>
                        <div class="title"><a class="title-link" href="/repo.html?repo=${encodeURIComponent(project.repo)}">${project.name}</a></div>
                        <div class="meta">${project.maintainer} · ${project.repo} · 更新 ${project.updated}</div>
                    </div>
                    <div class="row">
                        <span class="status-pill ${statusClass}">${project.status}</span>
                        <span class="tag">优先级 ${project.priority}</span>
                        <button class="heart-btn ${isFav ? 'active' : ''}" data-fav="${project.repo}" title="${isFav ? '取消关注' : '关注'}">❤</button>
                    </div>
                </header>
                <div class="desc">${project.description}</div>
                <div class="tags">
                    ${tags}
                </div>
                <div class="row">
                    <div class="metric">
                        <span class="label">OpenRank</span>
                        <span class="value">${Number(project.openrank || 0).toFixed(1)}</span>
                    </div>
                    <div class="metric">
                        <span class="label">Stars (月)</span>
                        <span class="value">${Number(project.stars || 0).toLocaleString()}</span>
                    </div>
                    <div class="metric">
                        <span class="label">趋势</span>
                        <span class="value">${project.trend}</span>
                    </div>
                </div>
                <div class="tasks">
                    ${tasks}
                </div>
            </article>
        `;
        }).join('');
    }

    function renderAll(list) {
        if (!allGrid) return;
        if (!list.length) {
            allGrid.innerHTML = `
                <article class="card">
                    <div class="title">暂无仓库</div>
                    <div class="desc">等待数据同步...</div>
                </article>
            `;
            return;
        }
        allGrid.innerHTML = list.map(p => {
            const isFav = favorites.has(p.repo);
            return `
            <article class="card">
                <header>
                    <div class="title"><a class="title-link" href="/repo.html?repo=${encodeURIComponent(p.repo)}">${p.name || p.repo}</a></div>
                    <div class="meta">${p.repo}</div>
                </header>
                <div class="desc">${p.description || ''}</div>
                <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
                    ${(p.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                    <span class="status-pill status-production">${p.status || ''}</span>
                    <span class="tag">OpenRank ${Number(p.openrank || 0).toFixed(1)}</span>
                    <button class="heart-btn ${isFav ? 'active' : ''}" data-fav="${p.repo}" title="${isFav ? '取消关注' : '关注'}">❤</button>
                </div>
            </article>
            `;
        }).join('');
    }

    function applyFilters() {
        const term = searchInput.value.trim().toLowerCase();
        const result = projects.filter(project => {
            const matchesFilter = activeFilter === 'all' || (project.tags || []).includes(activeFilter);
            const matchesTerm =
                project.name.toLowerCase().includes(term) ||
                project.maintainer.toLowerCase().includes(term) ||
                (project.repo || '').toLowerCase().includes(term) ||
                (project.tags || []).some(tag => tag.toLowerCase().includes(term));
            return matchesFilter && matchesTerm;
        });
        render(result);
    }

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            activeFilter = button.dataset.filter;
            filterButtons.forEach(btn => btn.classList.toggle('active', btn === button));
            applyFilters();
        });
    });

    searchInput.addEventListener('input', applyFilters);

    function updateAuthUI(message) {
        authHint.textContent = message;
        const loginLink = document.getElementById('login-link');
        const registerLink = document.getElementById('register-link');
        if (authToken) {
            logoutBtn.style.display = 'inline-flex';
            if (loginLink) loginLink.style.display = 'none';
            if (registerLink) registerLink.style.display = 'none';
        } else {
            logoutBtn.style.display = 'none';
            if (loginLink) loginLink.style.display = 'inline-flex';
            if (registerLink) registerLink.style.display = 'inline-flex';
        }
    }

    logoutBtn.addEventListener('click', () => {
        authToken = '';
        currentUser = '';
        localStorage.removeItem('openrank_token');
        localStorage.removeItem('openrank_user');
        favorites = new Set();
        updateAuthUI('未登录');
        render(projects);
        updateFollowStats();
    });

    followCard.addEventListener('click', () => {
        if (authToken) {
            window.location.href = '/favorites.html';
        } else {
            statusLine.textContent = '请先登录后查看跟进项目';
        }
    });

    async function loadProjects() {
        statusLine.textContent = '正在从 OpenDigger 榜单拉取数据...';
        try {
            let response = await fetch('/api/projects/discovery?limit=12');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            let data = await response.json();

            // 榜单为空则回退到固定仓库列表
            if (!Array.isArray(data) || data.length === 0) {
                statusLine.textContent = '榜单为空，回退到预置仓库列表...';
                response = await fetch('/api/projects');
                data = await response.json();
            } else {
                statusLine.textContent = '数据源：OpenDigger 榜单';
            }

            projects = data;
            const months = [...new Set(projects.map(p => p.updated).filter(Boolean))];
            statusLine.textContent += ` · 最近月度 ${months.join(', ') || '未知'}`;
            await loadFavorites();
            applyFilters();
        } catch (err) {
            statusLine.textContent = '数据拉取失败，请稍后再试';
            grid.innerHTML = `
                <article class="card">
                    <div class="title">OpenDigger 数据获取失败</div>
                    <div class="desc">${err.message}</div>
                </article>
            `;
        }
    }

    async function loadAllProjects() {
        if (!allStatusLine) return;
        allStatusLine.textContent = '正在加载全部仓库...';
        try {
            const resp = await fetch('/api/projects/all?limit=400');
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            allProjects = await resp.json();
            // 接口为空则回退到预置列表
            if (!Array.isArray(allProjects) || allProjects.length === 0) {
                const fallback = await fetch('/api/projects');
                if (fallback.ok) {
                    allProjects = await fallback.json();
                }
            }
            allStatusLine.textContent = `已加载 ${allProjects.length} 个仓库`;
            renderAll(allProjects);
        } catch (e) {
            allStatusLine.textContent = '全部仓库加载失败';
            try {
                const resp = await fetch('/api/projects');
                if (resp.ok) {
                    allProjects = await resp.json();
                    allStatusLine.textContent = `已加载 ${allProjects.length} 个仓库（预置列表）`;
                    renderAll(allProjects);
                    return;
                }
            } catch (err) { /* ignore */ }
            renderAll([]);
        }
    }

    async function loadFavorites() {
        if (!authToken) {
            favorites = new Set();
            updateFollowStats();
            return;
        }
        try {
            const resp = await fetch('/api/favorites', { headers: { 'X-Token': authToken } });
            if (!resp.ok) {
                favorites = new Set();
                updateFollowStats();
                return;
            }
            const data = await resp.json();
            favorites = new Set(data.map(item => item.repo));
            updateFollowStats();
        } catch (e) {
            favorites = new Set();
            updateFollowStats();
        }
    }

    function updateFollowStats() {
        if (!followCountEl || !followTrendEl) return;
        followCountEl.textContent = favorites.size;
        followTrendEl.textContent = authToken ? '已登录 · 跟进数' : '登录后统计';
    }

    async function toggleFavorite(repo) {
        if (!authToken) {
            updateAuthUI('请先登录再关注');
            return;
        }
        const isFav = favorites.has(repo);
        const method = 'POST';
        statusLine.textContent = isFav ? '取消关注中...' : '关注中...';
        try {
            const resp = await fetch('/api/favorites/toggle', {
                method,
                headers: { 'Content-Type': 'application/json', 'X-Token': authToken },
                body: JSON.stringify({ repo })
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                const msg = data.message || `操作失败 (${resp.status})`;
                updateAuthUI(msg);
                statusLine.textContent = msg;
                return;
            }
            if (favorites.has(repo)) {
                favorites.delete(repo);
            } else {
                favorites.add(repo);
            }
            statusLine.textContent = favorites.has(repo) ? '已加入关注' : '已取消关注';
            render(projects);
            renderAll(allProjects);
            updateFollowStats();
        } catch (e) {
            statusLine.textContent = '网络异常，稍后再试';
        }
    }

    grid.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-fav]');
        if (btn) {
            const repo = btn.getAttribute('data-fav');
            toggleFavorite(repo);
        }
    });

    if (allGrid) {
        allGrid.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-fav]');
            if (btn) {
                const repo = btn.getAttribute('data-fav');
                toggleFavorite(repo);
            }
        });
    }

    loadProjects();
    loadAllProjects();
    if (authToken) {
        updateAuthUI(`已登录：${currentUser || '用户'}`);
        updateFollowStats();
    }
</script>
</body>
</html>
